#!/system/bin/sh
# Exit immediately if any command exits with a non-zero status
set -e

# Determine the base directory of the script
BASEDIR=$(dirname "$0")
DEX="$BASEDIR/rish_shizuku.dex"

# Verify that the dex file exists
if [ ! -f "$DEX" ]; then
  echo "Error: Cannot find $DEX. Please check the tutorial in the Shizuku app." >&2
  exit 1
fi

# For Android 14+ (SDK >= 34), ensure the dex file is not writable
if [ "$(getprop ro.build.version.sdk)" -ge 34 ]; then
  if [ -w "$DEX" ]; then
    echo "On Android 14+, app_process cannot load a writable dex file."
    echo "Attempting to remove write permission from $DEX..."
    chmod 400 "$DEX"
  fi
  if [ -w "$DEX" ]; then
    echo "Error: Unable to remove write permission from $DEX." >&2
    echo "Suggestion: Copy the file to your terminal app's private directory (/data/data/<package>) where permission removal is possible." >&2
    exit 1
  fi
fi

# Set the terminal app's application ID if not already defined
[ -z "$RISH_APPLICATION_ID" ] && export RISH_APPLICATION_ID="PKG"

# Launch the app_process with the dex file and specified loader class
/system/bin/app_process -Djava.class.path="$DEX" /system/bin --nice-name=rish rikka.shizuku.shell.ShizukuShellLoader "$@"
